<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../bower_components/core-tooltip/core-tooltip.html">
<link rel="import" href="../bower_components/core-localstorage/core-localstorage.html">
<link rel="import" href="../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../bower_components/core-pages/core-pages.html">
<link rel="import" href="image-service.html">
<link rel="import" href="my-image.html">
<link rel="import" href="my-basket.html">
<link rel="import" href="my-details.html">
<link rel="import" href="my-gallery.html">

<script src="../bower_components/underscore/underscore.js"></script>

<polymer-element name="my-app">
<template>
    <link rel="stylesheet" href="myapp.css">

    <core-localstorage name="myapp-basket" value="{{basket}}"></core-localstorage>

    <image-service id="service" images="{{images}}"></image-service>

    <div id="main-container" vertical layout>
        <core-toolbar>
            <div flex>Scalac Image Viewer</div>
            <input type="text" value="{{filterText}}" placeholder="Filter images"/>
            <core-tooltip label="Gallery">
                <core-icon-button icon="refresh" on-tap="{{showGallery}}"></core-icon-button>
            </core-tooltip>
            <core-tooltip>
                <core-icon-button icon="shopping-basket" on-tap="{{toggleBasket}}"></core-icon-button>
                <ul tip>
                    <template repeat="{{ img in basket }}">
                        <li><img src="{{img.url}}" style="max-height: 40px; max-width: 40px;"/></li>
                    </template>
                </ul>
            </core-tooltip>
        </core-toolbar>

        <core-pages id="pages" selected="{{page}}" flex>
            <section id="imagesList">
                <my-gallery id="gallery" images="{{ images | filterImages | filterName(filterText) }}" on-action-call="{{toggleInBasket}}" inbasket="{{basket.length}}"></my-gallery>
            </section>
            <section id="basket"><my-basket data="{{basket}}"></my-basket></section>
        </core-pages>
    </div>
</template>

<script>
    (function(){
        Polymer('my-app', {
            page: 0,
            ready: function() {
                if(!this.basket) {
                    this.basket = [];
                } 
            },
            domReady: function() {
                var self = this;
                this.$.gallery.showAction = function(image) { return true; };
                this.$.gallery.actionIcon = function(image) {
                    if(!self.alreadyIn(image)) {
                        return "add-shopping-cart";
                    } else {
                        return "remove-circle";
                    }
                };
                this.$.gallery.actionLabel = function(image) {
                    return "";
                };
            },
            filterImages: function(images) {
                return _.where(images, {'mime': 'image/jpeg'});
            },
            filterName: function(images, name) {
                if(name == null || name == "")
                    return images
                name = name.toLowerCase();
                return _.filter(images, function(val) { return val.name.toLowerCase().indexOf(name) > -1; });
            },
            toggleBasket: function() { 
                this.page = (this.page+1) % 2;
            },
            showGallery: function() {
                //this.$.service.reload();
                this.$.gallery.showList();
                this.page = 0;
            },
            toggleInBasket: function(ev, image, sender) {
                if(!this.alreadyIn(image)) {
                    this.basket.push(image);
                } else {
                    var idx = this.indexOfUrl(image.url);
                    if(idx >= 0 ) {
                        this.basket.splice(idx, 1);                    
                    }
                }
            },
            alreadyIn: function(image) {
                return this.indexOfUrl(image.url) >= 0;
            },
            indexOfUrl: function(url) {
                return _.chain(this.basket).pluck('url').indexOf(url).value();
            }
        });
    })();
</script>

</polymer-element>
