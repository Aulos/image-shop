<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../bower_components/core-tooltip/core-tooltip.html">
<link rel="import" href="../bower_components/core-localstorage/core-localstorage.html">
<link rel="import" href="../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="image-service.html">
<link rel="import" href="my-image.html">
<link rel="import" href="my-basket.html">
<link rel="import" href="my-details.html">

<script src="../bower_components/underscore/underscore.js"></script>

<polymer-element name="my-app">
<template>
    <link rel="stylesheet" href="myapp.css">

    <core-localstorage name="myapp-basket" value="{{basket}}"></core-localstorage>

    <image-service id="service" images="{{images}}"></image-service>

    <div vertical layout>
        <core-toolbar>
            <div flex>Scalac Image Viewer</div>
            <input type="text" value="{{filterText}}" placeholder="Filter images"/>
            <core-tooltip label="Refresh">
                <core-icon-button icon="refresh" on-tap="{{refreshImages}}"></core-icon-button>
            </core-tooltip>
            <core-tooltip>
                <core-icon-button icon="shopping-basket" on-tap="{{showBasket}}"></core-icon-button>
                <ul tip>
                    <template repeat="{{image in basket}}">
                    <li><img src="{{image.url}}" style="max-height: 40px; max-width: 40px;"/></li>
                    </template>
                </ul>
            </core-tooltip>
        </core-toolbar>

        <core-animated-pages id="pages" valueattr="id" selected="{{page}}" flex transitions="hero-transition" on-core-animated-pages-transition-end="{{transComplete}}" layout vertical>
            <section id="imagesList" flex> 
                <div class="images-container" layout horizontal wrap>
                    <template repeat="{{image in images | filterImages | filterName(filterText) }}">
                    <div class="chip" on-tap="{{showDetails}}" on-add="{{addToBasket}}" layout vertical hero-id="{{image.url}}" hero?="{{currentImage === image}}"> 
                            <img class="art" flex src="{{image.url}}" hero-id="{{image.url}}.art" hero?="{{currentImage === image}}"/>
                            <div class="caption">{{image.name}}</div>
                            <core-icon-button class="addToBasket" icon="add-shopping-cart" on-tap="{{addToBasket}}"></core-icon-button>
                        </div>
                    </template>
                </div>
            </section>

            <section id="imageDetails">
                <div class="card" layout horizontal flex hero hero-id="{{currentImage.url}}">
                    <img src="{{currentImage.url}}" hero hero-id="{{currentImage.url}}.art" class="art"/>
                    <div layout vertical>
                        <h1 hero hero-id="{{currentImage.url}}.caption">{{currentImage.name}}</h1>
                        <p flex>Some details</p>
                        <div layout horizontal>
                            <core-icon-button id="add" icon="add-shopping-cart" on-tap="{{addToBasket}}">Add to basket</core-icon-button>
                        </div>
                    </div>
                </div>
            </section>
            <section id="basket"> 
                <div>
                    <h1 hero hero-id="caption">Basket</h1>
                    <my-basket></my-basket>
                </div>
            </section>
        </core-animated-pages>
    </div>
</template>

<script>
    Polymer('my-app', {
        page: "imagesList",
        ready: function() {
            if(this.basket == null) {
                this.basket = [];
            }
        },
        showBasket: function() { 
            console.log("Show basket"); 
            //this.$.pages.selected = 'basket';
            this.page = 'basket';
        },
        filterImages: function(images) {
            return _.where(images, {'mime': 'image/jpeg'});
        },
        filterName: function(images, name) {
            if(name == null || name == "")
                return images
            name = name.toLowerCase();
            return _.filter(images, function(val) { return val.name.toLowerCase().indexOf(name) > -1; });
        },
        showDetails: function(ev, d, sender) {
            var image = sender.templateInstance.model.image;
            this.currentImage = image;
            this.page = "imageDetails";
            //this.$.pages.selected = 'imageDetails';
        },
        refreshImages: function() {
            this.$.service.reload();
            this.page = 'imagesList';
            //this.$.pages.selected = 'imagesList';
        },
        addToBasket: function(ev, d, sender) {
            var image = this.currentImage;
            if(sender.templateInstance.model.image)
                image = sender.templateInstance.model.image;
            this.basket.push(image);            
        },
        transComplete: function () {
            console.log("Completed!");
        }
    });
    //CoreStyle.g.transitions.heroDuration = 10;
</script>

</polymer-element>
